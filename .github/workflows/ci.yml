name: Haskell CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Cache Stack work and dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.stack
          ~/.ghc
          .stack-work
        key: ${{ runner.os }}-stack-ghc-9.10.3-${{ hashFiles('**/stack.yaml','**/package.yaml','**/*.cabal') }}
        restore-keys: |
          ${{ runner.os }}-stack-ghc-9.10.3-
          ${{ runner.os }}-stack-

    - name: Set up GHC and Stack
      uses: haskell-actions/setup@v2
      with:
        ghc-version: '9.10.3'
        stack-version: '2.9.3'
        enable-stack: true
        stack-no-global: true
        stack-setup-ghc: true

    - name: Install GHC via Stack
      run: stack setup

    - name: Build dependencies only (cached step)
      run: stack build --only-dependencies --test --no-run-tests

    - name: Build library
      run: stack build --ghc-options "-Wall" --no-strip --no-haddock

    - name: Run tests (using pre-built artifacts)
      run: stack test --no-build --test-arguments="--quiet"

    - name: Run HLint
      run: stack exec -- hlint src test

    - name: Run Ormolu formatter check
      run: |
        for file in $(find src test -name "*.hs"); do
          stack exec -- ormolu --mode check "$file"
        done
